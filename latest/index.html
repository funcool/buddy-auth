<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="Andrey Antukh, &lt;niwi@niwi.nz&gt;">
<title>buddy-auth - Auth facilities for ring based apps.</title>
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f0f0f0; }
.listingblock .pygments .tok-c { color: #60a0b0; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #007020; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #60a0b0; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #007020 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #60a0b0; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #60a0b0; background-color: #fff0f0 } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #007020; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #007020; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #007020; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #007020 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #007020; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #902000 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #40a070 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #4070a0 } /* Literal.String */
.listingblock .pygments .tok-na { color: #4070a0 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #007020 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0e84b5; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #60add5 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #555555; font-weight: bold } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #d55537; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #007020 } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #06287e } /* Name.Function */
.listingblock .pygments .tok-nl { color: #002070; font-weight: bold } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #062873; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #bb60d5 } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #007020; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #40a070 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #40a070 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #40a070 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #40a070 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #40a070 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #4070a0 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #4070a0 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #4070a0; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #4070a0 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #4070a0; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #4070a0 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #70a0d0; font-style: italic } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #c65d09 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #235388 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #4070a0 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #517918 } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #007020 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #bb60d5 } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #bb60d5 } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #bb60d5 } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #40a070 } /* Literal.Number.Integer.Long */
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic|Liberation+Mono:400|Roboto+Slab:400,700"/>
<link rel="stylesheet" href="https://www.niwi.nz/_assets/asciidoctor-styles/simple-red-titles/stylesheet.css"/>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>buddy-auth - Auth facilities for ring based apps.</h1>
<div class="details">
<span id="author" class="author">Andrey Antukh, &lt;niwi@niwi.nz&gt;</span><br>
<span id="revdate">0.6.0</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#project-maturity">Project Maturity</a></li>
<li><a href="#install">Install</a>
<ul class="sectlevel2">
<li><a href="#requirements">Requirements</a></li>
<li><a href="#leiningen">Leiningen</a></li>
<li><a href="#gradle">Gradle</a></li>
</ul>
</li>
<li><a href="#authentication">Authentication</a>
<ul class="sectlevel2">
<li><a href="#http-basic">Http Basic</a></li>
<li><a href="#session">Session</a></li>
<li><a href="#token">Token</a></li>
<li><a href="#jws-token-stateless">JWS Token (Stateless)</a></li>
<li><a href="#jwe-token-stateless">JWE Token (Stateless)</a></li>
</ul>
</li>
<li><a href="#authorization">Authorization</a>
<ul class="sectlevel2">
<li><a href="#generic">Generic</a></li>
<li><a href="#access-rules">Access Rules</a></li>
</ul>
</li>
<li><a href="#examples">Examples</a>
<ul class="sectlevel2">
<li><a href="#example-httpbasic">Http Basic Auth Example</a></li>
<li><a href="#example-session">Session Auth Example</a></li>
<li><a href="#example-token">Token Auth Example</a></li>
<li><a href="#example-jwe">JWE Token Auth Example</a></li>
<li><a href="#example-jws">JWS Token Auth Example</a></li>
</ul>
</li>
<li><a href="#faq">FAQ</a></li>
<li><a href="#developers-guide">Developers Guide</a>
<ul class="sectlevel2">
<li><a href="#contributing">Contributing</a></li>
<li><a href="#philosophy">Philosophy</a></li>
<li><a href="#get-the-code">Get the Code</a></li>
<li><a href="#run-tests">Run tests</a></li>
<li><a href="#license">License</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="introduction"><a class="link" href="#introduction">Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>buddy-auth</em> module is dedicated to providing authentication facilities for
ring and ring based web applications.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="project-maturity"><a class="link" href="#project-maturity">Project Maturity</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since <em>buddy-auth</em> is a young project there may be some API breakage.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="install"><a class="link" href="#install">Install</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section covers the installation and requirements of the <em>buddy-auth</em> library.</p>
</div>
<div class="sect2">
<h3 id="requirements"><a class="link" href="#requirements">Requirements</a></h3>
<div class="paragraph">
<p><em>buddy-auth</em> is tested with these platforms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK7</p>
</li>
<li>
<p>JDK8</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="leiningen"><a class="link" href="#leiningen">Leiningen</a></h3>
<div class="paragraph">
<p>The simplest way to use <em>buddy-auth</em> in a clojure project is by including it in  your <strong><em>project.clj</em></strong> dependency vector:</p>
</div>
<div class="listingblock">
<div class="title"><em>In project.clj</em></div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">[</span><span class="tok-nv">buddy/buddy-auth</span> <span class="tok-s">&quot;0.6.0&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="gradle"><a class="link" href="#gradle">Gradle</a></h3>
<div class="paragraph">
<p>If you are using gradle, this is a sample dependency declaration using the gradle dsl:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">compile</span> <span class="tok-s2">&quot;buddy:buddy-auth:0.6.0&quot;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authentication"><a class="link" href="#authentication">Authentication</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Buddy takes a very different approach to handling authentication. First, it clearly distinguishes
authentication and authorization as two separate steps. Second, it implements these concepts using
protocols for easy extensibility.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Here is a list of the built-in authentication backends:</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Backend name</th>
<th class="tableblock halign-left valign-top">Namespace</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Http Basic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buddy.auth.backends.httpbasic</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Session</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buddy.auth.backends.session</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Token</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buddy.auth.backends.token</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JWS Token</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buddy.auth.backends.token</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JWE Token</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>buddy.auth.backends.token</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If you are not happy with built-in backends, you can implement your own and use it with
<em>buddy-auth</em> middleware without any problem.</p>
</div>
<div class="paragraph">
<p>Authentication in <em>buddy-auth</em> has two phases:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>parse</strong>: parsing incoming request headers, parameters etc&#8230;&#8203;</p>
</li>
<li>
<p><strong>authenticate</strong>: having parsed data, do the authentication process, such as calling
the auth function, unsigning the self contained token, etc.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="http-basic"><a class="link" href="#http-basic">Http Basic</a></h3>
<div class="paragraph">
<p>The HTTP Basic authentication backend is one of the simplest and most insecure authentication
systems, but is a good first step for understanding how <em>buddy-auth</em> authentication works.</p>
</div>
<div class="listingblock">
<div class="title">Example ring handler/view</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.auth</span> <span class="tok-ss">:refer</span> <span class="tok-p">(</span><span class="tok-nf">authenticated?</span><span class="tok-p">)])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">ring.util.response</span> <span class="tok-ss">:refer</span> <span class="tok-p">(</span><span class="tok-nf">response</span><span class="tok-p">)])</span>

<span class="tok-c1">;; Simple ring handler. This can also be a compojure router handler</span>
<span class="tok-c1">;; or anything else compatible with ring middleware.</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-sample-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">request</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nf">authenticated?</span> <span class="tok-nv">request</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">response</span> <span class="tok-p">(</span><span class="tok-nf">format</span> <span class="tok-s">&quot;Hello %s&quot;</span> <span class="tok-p">(</span><span class="tok-ss">:identity</span> <span class="tok-nv">request</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nf">response</span> <span class="tok-s">&quot;Hello Anonymous&quot;</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>authenticated?</code> function is a polymorphic function that receives a request and returns <code>true</code>
in case is already authenticated by one of <em>buddy-auth</em> backends or <code>false</code> in case contrary.</p>
</div>
<div class="paragraph">
<p>Later, http-basic authentication backend requires a function with the responsibility of identify the
incoming request. Let see how we can do it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.auth.backends.httpbasic</span> <span class="tok-ss">:refer</span> <span class="tok-p">[</span><span class="tok-nv">http-basic-backend</span><span class="tok-p">]])</span>

<span class="tok-c1">;; This function should return a non-nil value that</span>
<span class="tok-c1">;; is automatically stored with an :identity key on the request</span>
<span class="tok-c1">;; If it returns nil, a request is considered unauthenticated.</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-authfn</span>
  <span class="tok-p">[</span><span class="tok-nv">request</span> <span class="tok-nv">authdata</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">username</span> <span class="tok-p">(</span><span class="tok-ss">:username</span> <span class="tok-nv">authdata</span><span class="tok-p">)</span>
        <span class="tok-nv">password</span> <span class="tok-p">(</span><span class="tok-ss">:password</span> <span class="tok-nv">authdata</span><span class="tok-p">)]</span>
    <span class="tok-nv">username</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">backend</span> <span class="tok-p">(</span><span class="tok-nf">http-basic-backend</span> <span class="tok-p">{</span><span class="tok-ss">:realm</span> <span class="tok-s">&quot;MyApi&quot;</span> <span class="tok-ss">:authfn</span> <span class="tok-nv">my-authfn</span><span class="tok-p">}))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>authfn</strong> function should accept a <em>request</em> as the first parameter and <em>authdata</em> as the second.
<em>authdata</em> is data parsed from the request in the <strong>parse</strong> step.</p>
</div>
<div class="paragraph">
<p>The <strong>authfn</strong> will be called only if the <strong>parse</strong> process returns parsed data.</p>
</div>
<div class="paragraph">
<p>The next step for get it working, you should wrap your ring handler with authentication middleware:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.auth.middleware</span> <span class="tok-ss">:refer</span> <span class="tok-p">[</span><span class="tok-nv">wrap-authentication</span><span class="tok-p">]])</span>

<span class="tok-c1">;; Define the main handler with *app* name wrapping it</span>
<span class="tok-c1">;; with authentication middleware using an instance of the</span>
<span class="tok-c1">;; just created http-basic backend.</span>

<span class="tok-c1">;; Define app var with handler wrapped with _buddy-auth_&#39;s authentication</span>
<span class="tok-c1">;; middleware using the previously defined backend.</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span> <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-nv">my-sample-handler</span>
             <span class="tok-p">(</span><span class="tok-nf">wrap-authentication</span> <span class="tok-nv">backend</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All requests that reach the <code>my-sample-handler</code> will be properly processed and authenticated. In process
of authentication the <code>:identity</code> keyword will be attached to the request if a authentication is
successful.</p>
</div>
<div class="paragraph">
<p>You can see a complete example of using this backend <a href="#example-httpbasic">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="session"><a class="link" href="#session">Session</a></h3>
<div class="paragraph">
<p>The session backend has the simplest implementation because it relies entirely on ring session support.</p>
</div>
<div class="paragraph">
<p>The authentication process of this backend consists in checking the <code>:identity</code> keyword in session. If
it exists and is a logical true, it is automatically forwarded as is to <code>:identity</code> keyword in the
request.</p>
</div>
<div class="listingblock">
<div class="title">Example creating a session backend instance and wrapping our handler</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.auth.backends.session</span> <span class="tok-ss">:refer</span> <span class="tok-p">[</span><span class="tok-nv">session-backend</span><span class="tok-p">]])</span>

<span class="tok-c1">;; Create an instance</span>
<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">backend</span> <span class="tok-p">(</span><span class="tok-nf">session-backend</span><span class="tok-p">))</span>

<span class="tok-c1">;; Wrap the ring handler.</span>
<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span> <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-nv">my-sample-handler</span>
             <span class="tok-p">(</span><span class="tok-nf">wrap-authentication</span> <span class="tok-nv">backend</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
As you can see, the authentication is completely independent of login/signin. It&#8217;s up to
you to implement the login handler.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can see a complete example of using this backend <a href="#example-session">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="token"><a class="link" href="#token">Token</a></h3>
<div class="paragraph">
<p>Is a backend that uses tokens for authenticate the user. It behaves very similar to the basic-auth
backend with difference that instead of authenticating with credentials it authenticate with a simple
token.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.auth.backends.token</span> <span class="tok-ss">:refer</span> <span class="tok-p">[</span><span class="tok-nv">token-backend</span><span class="tok-p">]])</span>

<span class="tok-c1">;; Define a in-memory relation between tokens and users:</span>
<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">tokens</span> <span class="tok-p">{</span><span class="tok-ss">:2f904e245c1f5</span> <span class="tok-ss">:admin</span>
             <span class="tok-ss">:45c1f5e3f05d0</span> <span class="tok-ss">:foouser</span><span class="tok-p">})</span>

<span class="tok-c1">;; Define a authfn, function with the responsibility</span>
<span class="tok-c1">;; to authenticate the incoming token and return an</span>
<span class="tok-c1">;; identity instance</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-authfn</span>
  <span class="tok-p">[</span><span class="tok-nv">request</span> <span class="tok-nv">token</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">token</span> <span class="tok-p">(</span><span class="tok-nb">keyword </span><span class="tok-nv">token</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nb">get </span><span class="tok-nv">tokens</span> <span class="tok-nv">token</span> <span class="tok-nv">nil</span><span class="tok-p">)))</span>

<span class="tok-c1">;; Create a instance</span>
<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">backend</span> <span class="tok-p">(</span><span class="tok-nf">token-backend</span> <span class="tok-p">{</span><span class="tok-ss">:authfn</span> <span class="tok-nv">my-authfn</span><span class="tok-p">}))</span>

<span class="tok-c1">;; Wrap the ring handler.</span>
<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span> <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-nv">my-sample-handler</span>
             <span class="tok-p">(</span><span class="tok-nf">wrap-authentication</span> <span class="tok-nv">backend</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The process of authentication of this backend consists in parse the "Authorization" header
extract the token for it, and in case of the token is extracted successful, call the <code>authfn</code>
with extracted token.</p>
</div>
<div class="listingblock">
<div class="title">This is a possible aspect of the authorization header</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="text">Authorization: Token 45c1f5e3f05d0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>authfn</code> should return something that will be associated to the <code>:identity</code> key in the request.</p>
</div>
<div class="paragraph">
<p>Is the responsability of the library user to build tokens, handle its storage and verification
process. <em>buddy-auth</em> only offers a lightweight layer over http for parsing and mark requests
as authenticated.</p>
</div>
<div class="paragraph">
<p>You can see a complete example of using this backend <a href="#example-token">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="jws-token-stateless"><a class="link" href="#jws-token-stateless">JWS Token (Stateless)</a></h3>
<div class="paragraph">
<p>Is a backend that uses signed and self contained tokens for authenticate the user. It behaves very
similar to the <em>Token</em> backend (previously explained) with difference that this one does not need
additional user defined logic for validate tokens, because as we said previously, are self contained.</p>
</div>
<div class="paragraph">
<p>This type of tokens enables a complete stateless authentication because the server does not need any
more store the token and related information, the token will contain that information.</p>
</div>
<div class="paragraph">
<p>Let see an demostrative example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">secret</span> <span class="tok-s">&quot;mysecret&quot;</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">backend</span>
  <span class="tok-p">(</span><span class="tok-nf">auth/jws-backend</span> <span class="tok-p">{</span><span class="tok-ss">:secret</span> <span class="tok-nv">secret</span><span class="tok-p">}))</span>

<span class="tok-c1">;; and wrap your ring application with</span>
<span class="tok-c1">;; the authentication middleware</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span> <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-nv">your-ring-app</span>
             <span class="tok-p">(</span><span class="tok-nf">wrap-authentication</span> <span class="tok-nv">backend</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you should have a login endpoint in your ring application that will have the
responsability of generating valid tokens. This function may will be able to have
similar aspect to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.sign.jws</span> <span class="tok-ss">:as</span> <span class="tok-nv">jws</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">cheshire.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">json</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">login-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">request</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">data</span> <span class="tok-p">(</span><span class="tok-ss">:form-params</span> <span class="tok-nv">request</span><span class="tok-p">)</span>
        <span class="tok-nv">user</span> <span class="tok-p">(</span><span class="tok-nf">find-user</span> <span class="tok-p">(</span><span class="tok-ss">:username</span> <span class="tok-nv">data</span><span class="tok-p">)</span>   <span class="tok-c1">;; (implementation ommited)</span>
                        <span class="tok-p">(</span><span class="tok-ss">:password</span> <span class="tok-nv">data</span><span class="tok-p">))]</span>
    <span class="tok-p">{</span><span class="tok-ss">:status</span> <span class="tok-mi">200</span>
     <span class="tok-ss">:body</span> <span class="tok-p">(</span><span class="tok-nf">json/encode</span> <span class="tok-p">{</span><span class="tok-ss">:token</span> <span class="tok-p">(</span><span class="tok-nf">jws/sign</span> <span class="tok-p">{</span><span class="tok-ss">:user</span> <span class="tok-p">(</span><span class="tok-ss">:id</span> <span class="tok-nv">user</span><span class="tok-p">)}</span> <span class="tok-nv">secret</span><span class="tok-p">)})</span>
     <span class="tok-ss">:headers</span> <span class="tok-p">{</span><span class="tok-ss">:content-type</span> <span class="tok-s">&quot;application/json&quot;</span><span class="tok-p">})))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details about jws, see the <a href="https://funcool.github.io/buddy-sign/latest/#jws">buddy-sign</a>
documentation.</p>
</div>
<div class="paragraph">
<p>Some valuable resources for learning about stateless authentication are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://lucumr.pocoo.org/2013/11/17/my-favorite-database/" class="bare">http://lucumr.pocoo.org/2013/11/17/my-favorite-database/</a></p>
</li>
<li>
<p><a href="http://www.niwi.nz/2014/06/07/stateless-authentication-with-api-rest/" class="bare">http://www.niwi.nz/2014/06/07/stateless-authentication-with-api-rest/</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can see a complete example of using this backend <a href="#example-jws">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="jwe-token-stateless"><a class="link" href="#jwe-token-stateless">JWE Token (Stateless)</a></h3>
<div class="paragraph">
<p>This backend is almost identical to the previous one (JWS).</p>
</div>
<div class="paragraph">
<p>The main difference is that the backend uses JWE (Json Web Encryption) instead of JWS (Json Web Signature)
and it has the advangage that the content of token is encrypted instead of simply signed. This is useful
when token may contain some additional user information that can not be public.</p>
</div>
<div class="paragraph">
<p>This is how will look the previous (jws) example but using jwe with asymetric key encryption
algorithm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.sign.jwe</span> <span class="tok-ss">:as</span> <span class="tok-nv">jwe</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.core.keys</span> <span class="tok-ss">:as</span> <span class="tok-nv">keys</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">pubkey</span> <span class="tok-p">(</span><span class="tok-nf">keys/public-key</span> <span class="tok-s">&quot;pubkey.pem&quot;</span><span class="tok-p">))</span>
<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">privkey</span> <span class="tok-p">(</span><span class="tok-nf">keys/private-key</span> <span class="tok-s">&quot;privkey.pem&quot;</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">backend</span>
  <span class="tok-p">(</span><span class="tok-nf">auth/jwe-backend</span> <span class="tok-p">{</span><span class="tok-ss">:secret</span> <span class="tok-nv">privkey</span>
                     <span class="tok-ss">:options</span> <span class="tok-p">{</span><span class="tok-ss">:alg</span> <span class="tok-ss">:rsa-oaep</span> <span class="tok-ss">:enc</span> <span class="tok-ss">:a128-hs256</span><span class="tok-p">}}))</span>

<span class="tok-c1">;; and wrap your ring application with</span>
<span class="tok-c1">;; the authentication middleware</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span> <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-nv">your-ring-app</span>
             <span class="tok-p">(</span><span class="tok-nf">wrap-authentication</span> <span class="tok-nv">backend</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The corresponding login endpoint should have similar aspect to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.sign.jwe</span> <span class="tok-ss">:as</span> <span class="tok-nv">jwe</span><span class="tok-p">])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">cheshire.core</span> <span class="tok-ss">:as</span> <span class="tok-nv">json</span><span class="tok-p">])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">login-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">request</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">data</span> <span class="tok-p">(</span><span class="tok-ss">:form-params</span> <span class="tok-nv">request</span><span class="tok-p">)</span>
        <span class="tok-nv">user</span> <span class="tok-p">(</span><span class="tok-nf">find-user</span> <span class="tok-p">(</span><span class="tok-ss">:username</span> <span class="tok-nv">data</span><span class="tok-p">)</span>   <span class="tok-c1">;; (implementation ommited)</span>
                        <span class="tok-p">(</span><span class="tok-ss">:password</span> <span class="tok-nv">data</span><span class="tok-p">))</span>
        <span class="tok-nv">token</span> <span class="tok-p">(</span><span class="tok-nf">jwe/encrypt</span> <span class="tok-p">{</span><span class="tok-ss">:user</span> <span class="tok-p">(</span><span class="tok-ss">:id</span> <span class="tok-nv">user</span><span class="tok-p">)}</span> <span class="tok-nv">pubkey</span> <span class="tok-p">{</span><span class="tok-ss">:alg</span> <span class="tok-ss">:rsa-oaep</span> <span class="tok-ss">:enc</span> <span class="tok-ss">:a128-hs256</span><span class="tok-p">})]</span>
    <span class="tok-p">{</span><span class="tok-ss">:status</span> <span class="tok-mi">200</span>
     <span class="tok-ss">:body</span> <span class="tok-p">(</span><span class="tok-nf">json/encode</span> <span class="tok-p">{</span><span class="tok-ss">:token</span> <span class="tok-nv">token</span><span class="tok-p">})</span>
     <span class="tok-ss">:headers</span> <span class="tok-p">{</span><span class="tok-ss">:content-type</span> <span class="tok-s">&quot;application/json&quot;</span><span class="tok-p">})))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details about jwe, see the <a href="https://funcool.github.io/buddy-sign/latest/#jwe">buddy-sign</a>
documentation.</p>
</div>
<div class="paragraph">
<p>In order to use any asymetric encryption algorithm, you should have private/public
key pair. If you don&#8217;t have one, don&#8217;t worry, it is very easy to generate it using <strong>openssl</strong>, see
this <a href="https://funcool.github.io/buddy-sign/latest/#generate-keypairs">faq entry</a>.</p>
</div>
<div class="paragraph">
<p>You can see a complete example of using this backend <a href="#example-jwe">here</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authorization"><a class="link" href="#authorization">Authorization</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The second part of the auth process is authorization.</p>
</div>
<div class="paragraph">
<p>The authorization system is split into two parts: generic authorization and access-rules
(explained in the next section).</p>
</div>
<div class="paragraph">
<p>The generic one is based on exceptions, and consists in raising a unauthorized exception in case
of the request is considered unauthorized. And the access rules system is based in some kind of
rules attached to handler or a <em>URI</em> and that rules are determine if a request is autorized or not.</p>
</div>
<div class="sect2">
<h3 id="generic"><a class="link" href="#generic">Generic</a></h3>
<div class="paragraph">
<p>The authorization backend wraps everything in a try/catch block which only handles the specific
exception. When an unauthorized exception is caught, it executes a specific function to handle it or
reraises the exception.</p>
</div>
<div class="paragraph">
<p>With this approach we can define our own middlewared/decorators using custom authorization
logic with fast skip, raising an unauthorized exception using the <code>throw-unauthorized</code> function.</p>
</div>
<div class="listingblock">
<div class="title">Example ring handler raising an unauthorized exception.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.auth</span> <span class="tok-ss">:refer</span> <span class="tok-p">[</span><span class="tok-nv">authenticated?</span> <span class="tok-nv">throw-unauthorized</span><span class="tok-p">]])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">ring.util.response</span> <span class="tok-ss">:refer</span> <span class="tok-p">(</span><span class="tok-nf">response</span> <span class="tok-nv">redirect</span><span class="tok-p">)])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">home-controller</span>
  <span class="tok-p">[</span><span class="tok-nv">request</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nb">when </span><span class="tok-p">(</span><span class="tok-nb">not </span><span class="tok-p">(</span><span class="tok-nf">authenticated?</span> <span class="tok-nv">request</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nf">throw-unauthorized</span> <span class="tok-p">{</span><span class="tok-ss">:message</span> <span class="tok-s">&quot;Not authorized&quot;</span><span class="tok-p">}))</span>
  <span class="tok-p">(</span><span class="tok-nf">response</span> <span class="tok-s">&quot;Hello World&quot;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Just like the authentication system, authorization is also implemented using protocols.</p>
</div>
<div class="paragraph">
<p>All built-in backends are already implement the autorization protocol with default behavior. The
default behavior can be overridden passing the <code>:unauthorized-handler</code> option to the backend
constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.auth.backends.httpbasic</span> <span class="tok-ss">:refer</span> <span class="tok-p">[</span><span class="tok-nv">http-basic-backend</span><span class="tok-p">]])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.auth.middleware</span> <span class="tok-ss">:refer</span> <span class="tok-p">[</span><span class="tok-nv">wrap-authentication</span> <span class="tok-nv">wrap-authorization</span><span class="tok-p">]])</span>

<span class="tok-c1">;; Simple self defined handler for unauthorized requests.</span>
<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">my-unauthorized-handler</span>
  <span class="tok-p">[</span><span class="tok-nv">request</span> <span class="tok-nv">metadata</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-p">(</span><span class="tok-nf">response</span> <span class="tok-s">&quot;Unauthorized request&quot;</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nb">assoc </span><span class="tok-ss">:status</span> <span class="tok-mi">403</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">backend</span> <span class="tok-p">(</span><span class="tok-nf">http-basic-backend</span>
              <span class="tok-p">{</span><span class="tok-ss">:realm</span> <span class="tok-s">&quot;API&quot;</span>
               <span class="tok-ss">:authfn</span> <span class="tok-nv">my-auth-fn</span>
               <span class="tok-ss">:unauthorized-handler</span> <span class="tok-nv">my-unauthorized-handler</span><span class="tok-p">}))</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">app</span> <span class="tok-p">(</span><span class="tok-nb">-&gt; </span><span class="tok-nv">your-handler</span>
             <span class="tok-p">(</span><span class="tok-nf">wrap-authentication</span> <span class="tok-nv">backend</span><span class="tok-p">)</span>
             <span class="tok-p">(</span><span class="tok-nf">wrap-authorization</span> <span class="tok-nv">backend</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="access-rules"><a class="link" href="#access-rules">Access Rules</a></h3>
<div class="paragraph">
<p>The access rules system is another part of authorization. It consists of matching an url to
specific access rules logic.</p>
</div>
<div class="paragraph">
<p>The access rules consists of an ordered list. This contains mappings between urls and rule handlers using
<a href="https://github.com/weavejester/clout">clout</a> url matching syntax or regular expressions.</p>
</div>
<div class="listingblock">
<div class="title">This is an example of an access rule using the clout syntax.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">[{</span><span class="tok-ss">:uri</span> <span class="tok-s">&quot;/foo&quot;</span>
  <span class="tok-ss">:handler</span> <span class="tok-nv">user-access</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">This is an example of an access rule with more than one url matching using the clout syntax.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">[{</span><span class="tok-ss">:uris</span> <span class="tok-p">[</span><span class="tok-s">&quot;/foo&quot;</span> <span class="tok-s">&quot;/bar&quot;</span><span class="tok-p">]</span>
  <span class="tok-ss">:handler</span> <span class="tok-nv">user-access</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">The same example but using regular expressions.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">[{</span><span class="tok-ss">:pattern</span> <span class="tok-o">#</span><span class="tok-s">&quot;^/foo$&quot;</span>
  <span class="tok-ss">:handler</span> <span class="tok-nv">user-access</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An access rule can also match against certain HTTP methods, by using the <strong>:request-method</strong> option. <strong>:request-method</strong> can be a keyword or a set of keywords.</p>
</div>
<div class="listingblock">
<div class="title">An example of an access rule that matches only GET requests.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">[{</span><span class="tok-ss">:uri</span> <span class="tok-s">&quot;/foo&quot;</span>
  <span class="tok-ss">:handler</span> <span class="tok-nv">user-access</span>
  <span class="tok-ss">:request-method</span> <span class="tok-ss">:get</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="rules-handlers"><a class="link" href="#rules-handlers">Rules Handlers</a></h4>
<div class="paragraph">
<p>The rule handler is a plain function that accepts a request as a parameter and should return
<code>accessrules/success</code> or <code>accessrules/error</code>.</p>
</div>
<div class="paragraph">
<p>The <code>success</code> is a simple mark that means that handles passes the validation and <code>error</code> is a mark
that means the opposite, that the handler does not pass the validation. Instead of returning plain
boolean value, this approach allows handlers to return errors messages or even a ring response.</p>
</div>
<div class="listingblock">
<div class="title">This is a simple example of the aspect of one rule handler</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.auth</span> <span class="tok-ss">:refer</span> <span class="tok-p">(</span><span class="tok-nf">authenticated?</span><span class="tok-p">)])</span>
<span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.auth.accessrules</span> <span class="tok-ss">:refer</span> <span class="tok-p">(</span><span class="tok-nf">success</span> <span class="tok-nv">error</span><span class="tok-p">)])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">authenticated-user</span>
  <span class="tok-p">[</span><span class="tok-nv">request</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nf">authenticated?</span> <span class="tok-nv">request</span><span class="tok-p">)</span>
    <span class="tok-nv">true</span>
    <span class="tok-p">(</span><span class="tok-nf">error</span> <span class="tok-s">&quot;Only authenticated users allowed&quot;</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These values are considered success marks: <strong>true</strong> and <strong>success</strong> instances. These are considered error
marks: <strong>nil</strong>, <strong>false</strong>, and <strong>error</strong> instances. Error instances may contain a string as an error message
or a ring response hash-map.</p>
</div>
<div class="paragraph">
<p>Also, a rule handler can be a composition of several rule handlers using logical operators.</p>
</div>
<div class="listingblock">
<div class="title">This is the aspect of composition of rule-handlers</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">{</span><span class="tok-ss">:and</span> <span class="tok-p">[</span><span class="tok-nv">authenticated-user</span> <span class="tok-nv">other-handler</span><span class="tok-p">]}</span>
<span class="tok-p">{</span><span class="tok-ss">:or</span> <span class="tok-p">[</span><span class="tok-nv">authenticated-user</span> <span class="tok-nv">other-handler</span><span class="tok-p">]}</span>

<span class="tok-c1">;; Logical expressions can be nested as deep as you wish</span>
<span class="tok-c1">;; with hypotetical rule handlers with self descriptive name.</span>
<span class="tok-p">{</span><span class="tok-ss">:or</span> <span class="tok-p">[</span><span class="tok-nv">should-be-admin</span>
      <span class="tok-p">{</span><span class="tok-ss">:and</span> <span class="tok-p">[</span><span class="tok-nv">should-be-safe</span>
             <span class="tok-nv">should-be-authenticated</span><span class="tok-p">]}]}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is an example of how a composed rule handler can be used in an access rules list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">[{</span><span class="tok-ss">:pattern</span> <span class="tok-o">#</span><span class="tok-s">&quot;^/foo$&quot;</span>
  <span class="tok-ss">:handler</span> <span class="tok-p">{</span><span class="tok-ss">:and</span> <span class="tok-p">[</span><span class="tok-nv">authenticated-user</span> <span class="tok-nv">admin-user</span><span class="tok-p">]}}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, if you are using <strong>clout</strong> based syntax for matching access rules, the request in
a rule handler will contain <code>:match-params</code> with clout matched uri params.</p>
</div>
</div>
<div class="sect3">
<h4 id="usage"><a class="link" href="#usage">Usage</a></h4>
<div class="paragraph">
<p>Now, knowing how access rules and rule handlers can be defined, it is time to see how we can use
it in our ring applications.</p>
</div>
<div class="paragraph">
<p><em>buddy-auth</em> exposes two ways to do it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using a <em>wrap-access-rules</em> middleware.</p>
</li>
<li>
<p>Using a <em>restrict</em> decorator for assigning specific rules handlers to concrete ring handler.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here are couple of examples of how we could do it:</p>
</div>
<div class="listingblock">
<div class="title">Using <em>wrap-access-rules</em> middleware.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-c1">;; Rules handlers used on this example are ommited for code clarity</span>
<span class="tok-c1">;; Each handler represents authorization logic indicated by its name.</span>

<span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">rules</span> <span class="tok-p">[{</span><span class="tok-ss">:pattern</span> <span class="tok-o">#</span><span class="tok-s">&quot;^/admin/.*&quot;</span>
             <span class="tok-ss">:handler</span> <span class="tok-p">{</span><span class="tok-ss">:or</span> <span class="tok-p">[</span><span class="tok-nv">admin-access</span> <span class="tok-nv">operator-access</span><span class="tok-p">]}}</span>
            <span class="tok-p">{</span><span class="tok-ss">:pattern</span> <span class="tok-o">#</span><span class="tok-s">&quot;^/login$&quot;</span>
             <span class="tok-ss">:handler</span> <span class="tok-nv">any-access</span><span class="tok-p">}</span>
            <span class="tok-p">{</span><span class="tok-ss">:pattern</span> <span class="tok-o">#</span><span class="tok-s">&quot;^/.*&quot;</span>
             <span class="tok-ss">:handler</span> <span class="tok-nv">authenticated-access</span><span class="tok-p">}])</span>

<span class="tok-c1">;; Define default behavior for not authorized requests</span>
<span class="tok-c1">;;</span>
<span class="tok-c1">;; This function works like a default ring compatible handler</span>
<span class="tok-c1">;; and should implement the default behavior for requests</span>
<span class="tok-c1">;; which are not authorized by any defined rule</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">on-error</span>
  <span class="tok-p">[</span><span class="tok-nv">request</span> <span class="tok-nv">value</span><span class="tok-p">]</span>
  <span class="tok-p">{</span><span class="tok-ss">:status</span> <span class="tok-mi">403</span>
   <span class="tok-ss">:headers</span> <span class="tok-p">{}</span>
   <span class="tok-ss">:body</span> <span class="tok-s">&quot;Not authorized&quot;</span><span class="tok-p">})</span>

<span class="tok-c1">;; Wrap the handler with access rules (and run with jetty as example)</span>
<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">-main</span>
  <span class="tok-p">[</span><span class="tok-o">&amp;</span> <span class="tok-nv">args</span><span class="tok-p">]</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">[</span><span class="tok-nv">options</span> <span class="tok-p">{</span><span class="tok-ss">:rules</span> <span class="tok-nv">rules</span> <span class="tok-ss">:on-error</span> <span class="tok-nv">on-error</span><span class="tok-p">}</span>
        <span class="tok-nv">app</span>     <span class="tok-p">(</span><span class="tok-nf">wrap-access-rules</span> <span class="tok-nv">your-app-handler</span> <span class="tok-nv">options</span><span class="tok-p">)]</span>
    <span class="tok-p">(</span><span class="tok-nf">run-jetty</span> <span class="tok-nv">app</span> <span class="tok-p">{</span><span class="tok-ss">:port</span> <span class="tok-mi">9090</span><span class="tok-p">})))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If a request uri does not match any regular expression then the default policy is used.
The default policy in <em>buddy-auth</em> is <strong>allow</strong> but you can change the default behavior
specifying a <code>:reject</code> value in the <code>:policy</code> option.</p>
</div>
<div class="paragraph">
<p>Additionally, instead of specifying the global <em>on-error</em> handler, you can set a specific
behavior on a specific access rule, or use the <em>:redirect</em> option to simply redirect
a user to specific url.</p>
</div>
<div class="listingblock">
<div class="title">Lets see an example.</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-k">def </span><span class="tok-nv">rules</span> <span class="tok-p">[{</span><span class="tok-ss">:pattern</span> <span class="tok-o">#</span><span class="tok-s">&quot;^/admin/.*&quot;</span>
             <span class="tok-ss">:handler</span> <span class="tok-p">{</span><span class="tok-ss">:or</span> <span class="tok-p">[</span><span class="tok-nv">admin-access</span> <span class="tok-nv">operator-access</span><span class="tok-p">]}</span>
             <span class="tok-ss">:redirect</span> <span class="tok-s">&quot;/notauthorized&quot;</span><span class="tok-p">}</span>
            <span class="tok-p">{</span><span class="tok-ss">:pattern</span> <span class="tok-o">#</span><span class="tok-s">&quot;^/login$&quot;</span>
             <span class="tok-ss">:handler</span> <span class="tok-nv">any-access</span><span class="tok-p">}</span>
            <span class="tok-p">{</span><span class="tok-ss">:pattern</span> <span class="tok-o">#</span><span class="tok-s">&quot;^/.*&quot;</span>
             <span class="tok-ss">:handler</span> <span class="tok-nv">authenticated-access</span>
             <span class="tok-ss">:on-error</span> <span class="tok-p">(</span><span class="tok-k">fn </span><span class="tok-p">[</span><span class="tok-nv">req</span> <span class="tok-nv">_</span><span class="tok-p">]</span> <span class="tok-p">(</span><span class="tok-nf">response</span> <span class="tok-s">&quot;Not authorized ;)&quot;</span><span class="tok-p">))}])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The access rule options always takes precedence over the global ones.</p>
</div>
<div class="paragraph">
<p>Then, if you don&#8217;t want an external rules list and simply want to apply some rules to specific
ring views/handlers, you can use the <code>restrict</code> decorator. Let see it in action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="clojure"><span class="tok-p">(</span><span class="tok-nf">require</span> <span class="tok-o">&#39;</span><span class="tok-p">[</span><span class="tok-nv">buddy.auth.accessrules</span> <span class="tok-ss">:refer</span> <span class="tok-p">[</span><span class="tok-nv">restrict</span><span class="tok-p">]])</span>

<span class="tok-p">(</span><span class="tok-kd">defn </span><span class="tok-nv">home-controller</span>
  <span class="tok-p">[</span><span class="tok-nv">request</span><span class="tok-p">]</span>
  <span class="tok-p">{</span><span class="tok-ss">:body</span> <span class="tok-s">&quot;Hello World&quot;</span> <span class="tok-ss">:status</span> <span class="tok-mi">200</span><span class="tok-p">})</span>

<span class="tok-p">(</span><span class="tok-nf">defroutes</span> <span class="tok-nv">app</span>
  <span class="tok-p">(</span><span class="tok-nf">GET</span> <span class="tok-s">&quot;/&quot;</span> <span class="tok-p">[]</span> <span class="tok-p">(</span><span class="tok-nf">restrict</span> <span class="tok-nv">home-controller</span> <span class="tok-p">{</span><span class="tok-ss">:handler</span> <span class="tok-nv">should-be-authenticated</span>
                                         <span class="tok-ss">:on-error</span> <span class="tok-nv">on-error</span><span class="tok-p">}))</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples"><a class="link" href="#examples">Examples</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="example-httpbasic"><a class="link" href="#example-httpbasic">Http Basic Auth Example</a></h3>
<div class="paragraph">
<p>This example tries to show the way to setup http basic auth in a simple ring based
application.</p>
</div>
<div class="paragraph">
<p>You can see the example code here:
<a href="https://github.com/funcool/buddy-auth/tree/master/examples/httpbasic" class="bare">https://github.com/funcool/buddy-auth/tree/master/examples/httpbasic</a></p>
</div>
</div>
<div class="sect2">
<h3 id="example-session"><a class="link" href="#example-session">Session Auth Example</a></h3>
<div class="paragraph">
<p>This example tries to show the way to setup session based auth in a simple ring based
application.</p>
</div>
<div class="paragraph">
<p>You can see the example code here:
<a href="https://github.com/funcool/buddy-auth/tree/master/examples/session" class="bare">https://github.com/funcool/buddy-auth/tree/master/examples/session</a></p>
</div>
</div>
<div class="sect2">
<h3 id="example-token"><a class="link" href="#example-token">Token Auth Example</a></h3>
<div class="paragraph">
<p>This example tries to show the way to setup token based auth in a simple ring based
application.</p>
</div>
<div class="paragraph">
<p>You can see the example code here:
<a href="https://github.com/funcool/buddy-auth/tree/master/examples/token" class="bare">https://github.com/funcool/buddy-auth/tree/master/examples/token</a></p>
</div>
</div>
<div class="sect2">
<h3 id="example-jwe"><a class="link" href="#example-jwe">JWE Token Auth Example</a></h3>
<div class="paragraph">
<p>This example tries to show the way to setup jwe stateless token based auth in a
simple ring based application.</p>
</div>
<div class="paragraph">
<p>You can see the example code here:
<a href="https://github.com/funcool/buddy-auth/tree/master/examples/token-jwe" class="bare">https://github.com/funcool/buddy-auth/tree/master/examples/token-jwe</a></p>
</div>
</div>
<div class="sect2">
<h3 id="example-jws"><a class="link" href="#example-jws">JWS Token Auth Example</a></h3>
<div class="paragraph">
<p>This example tries to show the way to setup jws stateless token based auth in a
simple ring based application.</p>
</div>
<div class="paragraph">
<p>You can see the example code here:
<a href="https://github.com/funcool/buddy-auth/tree/master/examples/token-jws" class="bare">https://github.com/funcool/buddy-auth/tree/master/examples/token-jws</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="faq"><a class="link" href="#faq">FAQ</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>What is the difference with Friend?</strong></p>
</div>
<div class="paragraph">
<p><em>buddy-auth</em> authorization/authentication facilities are more low level and less opinionated
that friend, and allow you to build over them easy other high level abstractions.
Technically, friend abstraction can be build on top of <em>buddy-auth</em>.</p>
</div>
<div class="paragraph">
<p><strong>How can I use <em>buddy</em> with <a href="http://clojure-liberator.github.io/liberator/">liberator</a>?</strong></p>
</div>
<div class="paragraph">
<p>By design, <em>buddy</em> has authorization and authentication well
separated. This helps a lot if you want use only one part of it (ex:
authentication only) without including the other.</p>
</div>
<div class="paragraph">
<p>In summary: yes, you can use <em>buddy-auth</em> with liberator.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="developers-guide"><a class="link" href="#developers-guide">Developers Guide</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="contributing"><a class="link" href="#contributing">Contributing</a></h3>
<div class="paragraph">
<p>Unlike Clojure and other Clojure contributed libraries <em>buddy-auth</em> does not have many
restrictions for contributions. Just open an issue or pull request.</p>
</div>
</div>
<div class="sect2">
<h3 id="philosophy"><a class="link" href="#philosophy">Philosophy</a></h3>
<div class="paragraph">
<p>Five most important rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Beautiful is better than ugly.</p>
</li>
<li>
<p>Explicit is better than implicit.</p>
</li>
<li>
<p>Simple is better than complex.</p>
</li>
<li>
<p>Complex is better than complicated.</p>
</li>
<li>
<p>Readability counts.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All contributions to <em>buddy-auth</em> should keep these important rules in mind.</p>
</div>
</div>
<div class="sect2">
<h3 id="get-the-code"><a class="link" href="#get-the-code">Get the Code</a></h3>
<div class="paragraph">
<p><em>buddy-auth</em> is open source and can be found on <a href="https://github.com/funcool/buddy-auth">github</a>.</p>
</div>
<div class="paragraph">
<p>You can clone the public repository with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text">git clone https://github.com/funcool/buddy-auth</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-tests"><a class="link" href="#run-tests">Run tests</a></h3>
<div class="paragraph">
<p>For running tests just execute this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">lein <span class="tok-nb">test</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="license"><a class="link" href="#license">License</a></h3>
<div class="paragraph">
<p><em>buddy-auth</em> is licensed under Apache 2.0 License. You can see the complete text
of the license on the root of the repository on <code>LICENSE</code> file.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-07-04 12:05 EEST
</div>
</div>
</body>
</html>